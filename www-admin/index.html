<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deno Micro CMS Admin</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 1rem;
      max-width: 700px;
    }

    button {
      margin: 0.3rem 0.6rem 0.3rem 0;
    }

    textarea {
      width: 100%;
      height: 200px;
      font-family: monospace;
    }

    input[type="text"],
    select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.3rem;
      margin: 0.3rem 0 1rem 0;
    }

    label {
      display: block;
      margin-top: 1rem;
    }

    #status {
      margin-top: 1rem;
      min-height: 1.5em;
      color: green;
    }

    #status.error {
      color: red;
    }

    nav {
      margin-bottom: 1rem;
    }

    .link-btn {
      color: blue;
      background: none;
      border: none;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      font-size: 1em;
    }
  </style>
</head>

<body>
  <h1>Deno Micro CMS Admin</h1>

  <!-- Auth Section -->
  <div id="auth-section">
    <div id="login-form">
      <label>
        Passcode:
        <input type="password" id="passcode-input" />
      </label>
      <button id="sign-in-btn">Sign In</button>
    </div>
    <div id="auth-info" style="display:none;">
      <button id="sign-out-btn">Sign Out</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" style="display:none;">
    <nav>
      <button id="new-category-btn">+ New Category</button>
      <button id="refresh-categories-btn">Refresh Categories</button>
    </nav>

    <!-- Category List Page -->
    <div id="category-page">
      <h2>Categories</h2>
      <ul id="category-list"></ul>
    </div>

    <!-- Blob List Page -->
    <div id="list-page" style="display:none;">
      <button id="back-to-categories-btn">← Back to Categories</button>
      <h2 id="category-title"></h2>
      <nav>
        <button id="new-blob-btn">+ New Blob</button>
        <button id="refresh-list-btn">Refresh List</button>
        <button id="delete-category-btn" style="color:red;">Delete Category</button>
      </nav>
      <ul id="blob-list"></ul>
    </div>

    <!-- Blob Detail Page -->
    <div id="detail-page" style="display:none;">
      <button id="back-to-list-btn">← Back to List</button>
      <h2 id="detail-title">Blob Detail</h2>

      <label>
        Category:
        <input type="text" id="blob-category" />
      </label>

      <label>
        Key:
        <input type="text" id="blob-key" />
      </label>

      <label>
        MIME Type:
        <input type="text" id="blob-mime" placeholder="e.g. text/plain or image/png" />
      </label>

      <label>
        Content Type:
        <select id="content-type-select">
          <option value="text">Text</option>
          <option value="file">File</option>
        </select>
      </label>

      <div id="text-content-container">
        <label>
          Content:
          <textarea id="blob-content"></textarea>
        </label>
      </div>

      <div id="file-content-container" style="display:none;">
        <label>
          Upload file:
          <input type="file" id="blob-file" />
        </label>
        <div id="existing-file-link" style="margin-top: 0.5rem;"></div>
      </div>

      <div style="margin-top:1rem;">
        <button id="create-btn">Create</button>
        <button id="update-btn">Update</button>
        <button id="delete-btn" style="color:red;">Delete</button>
      </div>
    </div>
  </div>

  <div id="status"></div>

  <script>
    (() => {
      const apiBase = '/api';

      // Auth elements
      const loginForm = document.getElementById('login-form');
      const passcodeInput = document.getElementById('passcode-input');
      const signInBtn = document.getElementById('sign-in-btn');
      const authInfo = document.getElementById('auth-info');
      const signOutBtn = document.getElementById('sign-out-btn');

      // Dashboard
      const dashboard = document.getElementById('dashboard');
      const statusElem = document.getElementById('status');

      // Category
      const categoryPage = document.getElementById('category-page');
      const categoryList = document.getElementById('category-list');
      const newCategoryBtn = document.getElementById('new-category-btn');
      const refreshCategoriesBtn = document.getElementById('refresh-categories-btn');

      // Blob list
      const listPage = document.getElementById('list-page');
      const categoryTitle = document.getElementById('category-title');
      const blobList = document.getElementById('blob-list');
      const newBlobBtn = document.getElementById('new-blob-btn');
      const refreshListBtn = document.getElementById('refresh-list-btn');
      const deleteCategoryBtn = document.getElementById('delete-category-btn');
      const backToCategoriesBtn = document.getElementById('back-to-categories-btn');

      // Blob detail
      const detailPage = document.getElementById('detail-page');
      const backToListBtn = document.getElementById('back-to-list-btn');
      const detailTitle = document.getElementById('detail-title');
      const blobCategoryInput = document.getElementById('blob-category');
      const blobKeyInput = document.getElementById('blob-key');
      const blobMimeInput = document.getElementById('blob-mime');
      const contentTypeSelect = document.getElementById('content-type-select');
      const textContentContainer = document.getElementById('text-content-container');
      const fileContentContainer = document.getElementById('file-content-container');
      const blobContentInput = document.getElementById('blob-content');
      const blobFileInput = document.getElementById('blob-file');
      const existingFileLink = document.getElementById('existing-file-link');
      const createBtn = document.getElementById('create-btn');
      const updateBtn = document.getElementById('update-btn');
      const deleteBtn = document.getElementById('delete-btn');

      let currentCategory = null;
      let editingKey = null;

      // Helpers
      function setStatus(msg, isError = false) {
        statusElem.textContent = msg;
        statusElem.className = isError ? 'error' : '';
      }

      function clearStatus() { setStatus(''); }

      // ---- Auth ----
      async function checkAuth() {
        try {
          const res = await fetch(apiBase + '/auth', { credentials: 'include' });
          if (res.status === 200) {
            loginForm.style.display = 'none';
            authInfo.style.display = 'block';
            dashboard.style.display = 'block';
            showCategoryPage();
          } else {
            loginForm.style.display = 'block';
            authInfo.style.display = 'none';
            dashboard.style.display = 'none';
          }
        } catch {
          setStatus('Network error checking authentication', true);
        }
      }

      signInBtn.onclick = async () => {
        const passcode = passcodeInput.value.trim();
        if (!passcode) return setStatus('Passcode cannot be empty', true);
        try {
          const res = await fetch(apiBase + '/auth/sign-in', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ passcode })
          });
          if (res.status === 200) {
            setStatus('Signed in');
            checkAuth();
          } else setStatus('Failed to sign in', true);
        } catch {
          setStatus('Network error during sign in', true);
        }
      };

      signOutBtn.onclick = async () => {
        try {
          await fetch(apiBase + '/auth/sign-out', { method: 'POST', credentials: 'include' });
          setStatus('Signed out');
          checkAuth();
        } catch {
          setStatus('Network error during sign out', true);
        }
      };

      // ---- Category Management ----
      async function loadCategories() {
        categoryList.innerHTML = '<li>Loading...</li>';
        try {
          const res = await fetch(apiBase + '/blob', { credentials: 'include' });
          if (!res.ok) throw new Error('Failed to load categories');
          const cats = await res.json();
          categoryList.innerHTML = '';
          if (!cats || cats.length === 0) {
            categoryList.innerHTML = '<li><em>No categories.</em></li>';
          } else {
            cats.forEach(cat => {
              const li = document.createElement('li');
              const btn = document.createElement('button');
              btn.className = 'link-btn';
              btn.textContent = cat;
              btn.onclick = () => showBlobList(cat);
              li.appendChild(btn);
              categoryList.appendChild(li);
            });
          }
          clearStatus();
        } catch (e) {
          setStatus(e.message, true);
        }
      }

      async function createCategory() {
        const name = prompt('Enter new category name:');
        if (!name) return;
        try {
          const res = await fetch(apiBase + '/blob/' + encodeURIComponent(name), {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: '{}'
          });
          if (res.ok) {
            setStatus('Category created');
            loadCategories();
          } else setStatus('Failed to create category', true);
        } catch {
          setStatus('Network error creating category', true);
        }
      }

      async function deleteCategory() {
        if (!currentCategory) return;
        if (!confirm(`Delete category "${currentCategory}" and all blobs?`)) return;
        try {
          const res = await fetch(apiBase + '/blob/' + encodeURIComponent(currentCategory), {
            method: 'DELETE',
            credentials: 'include'
          });
          if (res.ok) {
            setStatus('Category deleted');
            showCategoryPage();
          } else setStatus('Failed to delete category', true);
        } catch {
          setStatus('Network error deleting category', true);
        }
      }

      // ---- Page switches ----
      function showCategoryPage() {
        categoryPage.style.display = 'block';
        listPage.style.display = 'none';
        detailPage.style.display = 'none';
        loadCategories();
      }

      function showBlobList(category) {
        currentCategory = category;
        categoryTitle.textContent = `Category: ${category}`;
        categoryPage.style.display = 'none';
        listPage.style.display = 'block';
        detailPage.style.display = 'none';
        loadBlobList();
      }

      function showDetailPage(isNew = false) {
        categoryPage.style.display = 'none';
        listPage.style.display = 'none';
        detailPage.style.display = 'block';
        blobCategoryInput.value = currentCategory;
        blobCategoryInput.disabled = true;
        if (isNew) {
          detailTitle.textContent = 'Create New Blob';
          blobKeyInput.value = '';
          blobKeyInput.disabled = false;
          blobMimeInput.value = 'text/plain';
          contentTypeSelect.value = 'text';
          blobContentInput.value = '';
          blobFileInput.value = '';
          existingFileLink.innerHTML = '';
          createBtn.style.display = '';
          updateBtn.style.display = 'none';
          deleteBtn.style.display = 'none';
          editingKey = null;
        } else {
          detailTitle.textContent = 'Edit Blob';
          blobKeyInput.disabled = true;
          createBtn.style.display = 'none';
          updateBtn.style.display = '';
          deleteBtn.style.display = '';
        }
      }

      // ---- Blobs ----
      async function loadBlobList() {
        blobList.innerHTML = '<li>Loading...</li>';
        try {
          const res = await fetch(apiBase + '/blob/' + encodeURIComponent(currentCategory), { credentials: 'include' });
          if (!res.ok) throw new Error('Failed to load blob list');
          const blobs = await res.json();
          blobList.innerHTML = '';
          if (blobs.length === 0) blobList.innerHTML = '<li><em>No blobs found.</em></li>';
          else {
            blobs.forEach(key => {
              const li = document.createElement('li');
              const btn = document.createElement('button');
              btn.className = 'link-btn';
              btn.textContent = key;
              btn.onclick = () => loadBlobDetail(key);
              li.appendChild(btn);
              blobList.appendChild(li);
            });
          }
        } catch (e) {
          setStatus(e.message, true);
        }
      }

      async function loadBlobDetail(key) {
        editingKey = key;
        showDetailPage(false);
        blobKeyInput.value = key;
        try {
          const res = await fetch(`${apiBase}/blob/${encodeURIComponent(currentCategory)}/${encodeURIComponent(key)}`, { credentials: 'include' });
          if (!res.ok) throw new Error('Blob not found');
          const mime = res.headers.get('Content-Type') || '';
          blobMimeInput.value = mime;
          if (mime.startsWith('text/') || mime === 'application/json' || mime === 'application/javascript') {
            contentTypeSelect.value = 'text';
            blobContentInput.value = await res.text();
            existingFileLink.innerHTML = '';
          } else {
            contentTypeSelect.value = 'file';
            existingFileLink.innerHTML = `<a href="${apiBase}/blob/${encodeURIComponent(currentCategory)}/${encodeURIComponent(key)}" target="_blank" download>Download current file</a>`;
          }
          blobFileInput.value = '';
          clearStatus();
        } catch (e) {
          setStatus(e.message, true);
          showBlobList(currentCategory);
        }
      }

      async function saveBlob(isCreate) {
        const key = blobKeyInput.value.trim();
        const mime = blobMimeInput.value.trim() || 'application/octet-stream';
        if (!key) return setStatus('Key cannot be empty', true);

        let body;
        if (contentTypeSelect.value === 'text') body = blobContentInput.value;
        else {
          const file = blobFileInput.files[0];
          if (!file) return setStatus('Select a file first', true);
          body = file;
        }

        try {
          const res = await fetch(`${apiBase}/blob/${encodeURIComponent(currentCategory)}/${encodeURIComponent(key)}`, {
            method: isCreate ? 'POST' : 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': mime },
            body
          });
          if (res.ok) {
            setStatus(`Blob ${isCreate ? 'created' : 'updated'}`);
            showBlobList(currentCategory);
          } else {
            setStatus(`Failed to ${isCreate ? 'create' : 'update'} blob`, true);
          }
        } catch {
          setStatus('Network error saving blob', true);
        }
      }

      async function deleteBlob() {
        if (!editingKey) return;
        if (!confirm(`Delete blob "${editingKey}"?`)) return;
        try {
          const res = await fetch(`${apiBase}/blob/${encodeURIComponent(currentCategory)}/${encodeURIComponent(editingKey)}`, {
            method: 'DELETE', credentials: 'include'
          });
          if (res.ok) {
            setStatus('Blob deleted');
            showBlobList(currentCategory);
          } else setStatus('Failed to delete blob', true);
        } catch {
          setStatus('Network error deleting blob', true);
        }
      }

      // ---- Event bindings ----
      contentTypeSelect.onchange = () => {
        const isText = contentTypeSelect.value === 'text';
        textContentContainer.style.display = isText ? 'block' : 'none';
        fileContentContainer.style.display = isText ? 'none' : 'block';
      };

      newCategoryBtn.onclick = createCategory;
      refreshCategoriesBtn.onclick = loadCategories;
      deleteCategoryBtn.onclick = deleteCategory;
      backToCategoriesBtn.onclick = showCategoryPage;

      newBlobBtn.onclick = () => showDetailPage(true);
      refreshListBtn.onclick = loadBlobList;
      backToListBtn.onclick = () => showBlobList(currentCategory);
      createBtn.onclick = () => saveBlob(true);
      updateBtn.onclick = () => saveBlob(false);
      deleteBtn.onclick = deleteBlob;

      // Init
      checkAuth();
    })();
  </script>
</body>
</html>
